(function ($) {
  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != "") {
      var cookies = document.cookie.split(";");
      for (var i = 0; i < cookies.length; i++) {
        var cookie = $.trim(cookies[i]);
        if (cookie.substring(0, name.length + 1) == name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    //RETORNANDO EL TOKEN
    return cookieValue;
  } //end function getCookie
  function generarCodigo(id) {}
  $(document).ready(function () {
    console.log("is created 11!!");
    $(".field-donante_fuente select").change(function () {
      console.log("is created 2!!");
      let id = $(".field-donante_fuente select option:selected").val();

      let url = "/countingresos/" + id;
      console.log("url", url);
      let csrftoken = getCookie("csrftoken");

      $.ajax({
        type: "POST",
        url: url,
        data: {
          csrfmiddlewaretoken: csrftoken,
        },
        success: function (data) {
          let count = "";
          count = parseInt(data);
          console.log("count1", count);
          isNaN(count) ? (count = 0) : count++;
          console.log("count2", count);
          console.log("count3", count);
          let nombre = $(".field-donante_fuente select option:selected")
            .text()
            .replace(/ /g, "_")
            .substring(0, 20)
            .toUpperCase();
          $(".field-codigo input").val(nombre + "-" + count);
        },
        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status === 0) {
            alert(
              "Error al intentar Conectarse: Verifique su conexion a Internet."
            );
          } else if (jqXHR.status == 404) {
            alert("La Pagina solicitada no fue encontrada [404]");
          } else if (jqXHR.status == 500) {
            alert("Erro Interno [500]");
          } else if (textStatus === "parsererror") {
            alert("Error en el retorno de Datos. [parseJson]");
          } else if (textStatus === "timeout") {
            alert("Tiempo de Espera agotado");
          } else if (textStatus === "abort") {
            alert("Solicitud Abortada. [Ajax Request]");
          } else {
            alert("Error desconocido: " + jqXHR.responseText);
          } //end if
        }, //end error
      });
    });

    //Disables editable field, input data generated by code
    $(".field-codigo input").prop("disabled", true);
    //Enabled disabled before save, to allow saving of object
    $(".submit-row input").click(function () {
      $(".field-codigo input").prop("disabled", false);
    });
  });
})(django.jQuery);
